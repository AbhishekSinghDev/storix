import { createFileRoute } from "@tanstack/react-router"
import { createAPIFileRoute } from "@tanstack/start/api";
import { z } from "zod";

import { auth } from "~/utils/auth";

const signUpSchema = z.object({
  name: z.string(),
  email: z.string().email("email is required"),
  password: z.string().min(6, "password must contain 6 characters"),
});

export const Route = createAPIFileRoute("/api/auth/signup")({
  POST: async ({ request }) => {
    try {
      const body = await request.json();
      console.log(body);

      // validating data coming from body
      const validateData = signUpSchema.parse(body);

      // creating a new user
      const user = await auth.api.signUpEmail({
        body: {
          name: validateData.name,
          email: validateData.email,
          password: validateData.password,
        },
      });

      if (!user) {
        return new Response(
          JSON.stringify({
            success: false,
            error: "error occurred while creating a user",
          }),
          {
            status: 404,
          },
        );
      }

      return new Response(
        JSON.stringify({
          success: true,
          message: "Account created successfully",
          user,
        }),
        {
          status: 201,
        },
      );
    } catch (error) {
      console.log("signup error", error);

      return new Response(
        JSON.stringify({
          messgae: "Error occured while signing up user",
          error,
        }),
        {
          status: 500,
        },
      );
    }
  },
});
